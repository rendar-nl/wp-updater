name: Pre-release (non-main) â€“ branch prereleases

on:
  push:
    branches-ignore: [ main ]

jobs:
  prerelease:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      # Ensure baseline tag exists on main so prerelease naming has an anchor
      - name: Bootstrap initial tag if none (on main)
        id: bootstrap
        run: |
          git fetch origin main --depth=1
          git fetch --tags --force
          if [ -z "$(git tag -l)" ]; then
            echo "initial=true" >> $GITHUB_OUTPUT
            git config user.email "actions@github.com"
            git config user.name "github-actions"
            git tag -a v1.0.0 origin/main -m "Initial tag (on main)"
            git push origin v1.0.0
          else
            echo "initial=false" >> $GITHUB_OUTPUT
          fi

      - name: Prepare prerelease version
        id: ver
        run: |
          base="$(git describe --tags --abbrev=0 2>/dev/null || echo v1.0.0)"
          base="${base#v}"
          pre="${GITHUB_REF_NAME//[^a-zA-Z0-9.-]/-}"
          echo "tag=v${base}-${pre}.${GITHUB_RUN_NUMBER}" >> $GITHUB_OUTPUT
          echo "ver=${base}-${pre}.${GITHUB_RUN_NUMBER}" >> $GITHUB_OUTPUT

      # Idempotent: delete same prerelease/tag if it exists
      - name: Delete previous prerelease (same tag) if exists
        continue-on-error: true
        run: |
          gh release delete "${{ steps.ver.outputs.tag }}" -y || true
          git push origin :refs/tags/"${{ steps.ver.outputs.tag }}" || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Zip source
        run: |
          mkdir -p dist
          zip -r "dist/rendar-wp-updater-${{ steps.ver.outputs.ver }}.zip" . -x '.git/*' '.github/*' 'tests/*'

      - name: Create prerelease
        uses: softprops/action-gh-release@v2
        with:
          prerelease: true
          tag_name: ${{ steps.ver.outputs.tag }}
          name: ${{ steps.ver.outputs.tag }}
          files: dist/*.zip
          generate_release_notes: true
